*** a/js/UI.js
--- b/js/UI.js
@@
 async function run(auto) {
   // ... existing setup

-  // const r = fixCode(raw, opts);
-  // code = r.code;
+  // NEW: send to worker with mode toggle
+  const worker = new Worker('js/worker.js');
+  const mode = (document.querySelector('#engineMode')?.value) || 'rules';
+  const diagram = (document.querySelector('#diagramType')?.value) || 'auto';
+  const raw = document.querySelector('#src').value;
+  document.querySelector('#status').textContent = '分析中...';
+  worker.onmessage = async (event) => {
+    const { code, log, dtype } = event.data;
+    console.log('[Worker]', log);
+    const { svg } = await renderMermaid(code);
+    document.querySelector('svg').innerHTML = svg;
+    document.querySelector('#status').textContent = `完成 (engine=${mode}, type=${dtype})`;
+    // TODO: render logs
+  };
+  worker.postMessage({
+    files: { 'stdin': raw },
+    opts: { mode, diagram }
+  });
 }
